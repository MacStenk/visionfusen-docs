openapi: 3.1.0
info:
  title: VisionFusen API
  version: 2.1.0
  description: |
    Kryptografische Urheberschaftsnachweise für Dateien mit NIP-94 auf Nostr.
    
    ## Unterstützte Formate
    
    | Typ | Formate | Metadaten-Quelle |
    |-----|---------|------------------|
    | **Bilder** | WebP, PNG, JPEG, GIF | XMP/EXIF |
    | **Dokumente** | PDF | PDF-Info Dictionary |
    | **Text** | Markdown (.md), Plain Text (.txt) | YAML Frontmatter |
    
    ## Funktionsweise
    
    1. **Datei hochladen** - Als Datei oder URL
    2. **Typ erkennen** - MIME-Type wird automatisch erkannt
    3. **Metadaten auslesen** - Je nach Typ (XMP, PDF-Info, Frontmatter)
    4. **Autor validieren** - Pflichtfeld für Signierung
    5. **Hash berechnen** - SHA-256 für eindeutige Identifikation
    6. **NIP-94 Event erstellen** - Nostr-Event mit allen Metadaten
    7. **Signieren & Publishen** - Auf Nostr Relays veröffentlichen
    8. **Statische Event-Page** - LLM-optimierte HTML-Seite generieren
  contact:
    name: VisionFusen
    url: https://visionfusen.org

servers:
  - url: https://visionfusen.org/api
    description: Production

tags:
  - name: Signing
    description: Dateien signieren
  - name: Verification
    description: Signaturen prüfen
  - name: Badge
    description: Verifizierungs-Badges

paths:
  /sign-image-v2:
    post:
      operationId: signFile
      summary: Datei signieren
      description: |
        Signiert eine Datei mit NIP-94 und veröffentlicht sie auf Nostr Relays.
        
        **Unterstützte Formate:**
        - Bilder: WebP, PNG, JPEG, GIF
        - Dokumente: PDF
        - Text: Markdown (.md), Plain Text (.txt)
        
        Die Datei **muss** einen gültigen Autor haben:
        - Bilder: In XMP-Metadaten (`dc:creator`)
        - PDF: In PDF-Info (`/Author`)
        - Markdown/Text: Im YAML Frontmatter (`author:`)
      tags:
        - Signing
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Datei (Bild, PDF, Markdown, Text)
                image:
                  type: string
                  format: binary
                  description: Alias für `file` (Backwards Compatible)
                url:
                  type: string
                  format: uri
                  description: Alternative - Datei-URL statt Upload
          application/json:
            schema:
              type: object
              properties:
                file_base64:
                  type: string
                  description: Datei als Base64-String
                image_base64:
                  type: string
                  description: Alias für `file_base64` (Backwards Compatible)
                file_url:
                  type: string
                  format: uri
                  description: Öffentlich erreichbare Datei-URL
                image_url:
                  type: string
                  format: uri
                  description: Alias für `file_url` (Backwards Compatible)
                filename:
                  type: string
                  description: Dateiname (für Typ-Erkennung bei Base64)
      responses:
        '200':
          description: Datei erfolgreich signiert
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  hash:
                    type: string
                    description: SHA-256 Hash
                    example: "8a97b9bedaddf1096325fa44cec4f6f43b57273230c5bdae003b613b896252ea"
                  file_type:
                    type: string
                    description: Erkannter Dateityp
                    enum: [image, document, text]
                    example: "text"
                  metadata:
                    type: object
                    properties:
                      author:
                        type: string
                        example: "Steven Noack"
                      title:
                        type: string
                        example: "VisionFusen - Roadmap & Ideen"
                      description:
                        type: string
                  dimensions:
                    type: object
                    description: Nur für Bilder
                    properties:
                      width:
                        type: integer
                      height:
                        type: integer
                  mime_type:
                    type: string
                    example: "text/markdown"
                  size_bytes:
                    type: integer
                    example: 12543
                  event:
                    type: object
                    description: Signiertes NIP-94 Event (Kind 1063)
                  published_to:
                    type: array
                    items:
                      type: string
                    example: ["relay.visionfusen.org", "relay.damus.io", "relay.primal.net", "nos.lol"]
                  urls:
                    type: object
                    properties:
                      file:
                        type: string
                        description: CDN-URL der Datei
                        example: "https://cdn.visionfusen.org/documents/visionfusen-roadmap-ideen.vf1063-8a97b9be.md"
                      static_page:
                        type: string
                        description: LLM-optimierte HTML-Seite
                        example: "https://cdn.visionfusen.org/events/14b89a28.../index.html"
                      event_page:
                        type: string
                        description: Event-Seite auf visionfusen.org
                        example: "https://visionfusen.org/event/14b89a28..."
                      verify:
                        type: string
                        description: Verifizierungs-URL
                        example: "https://visionfusen.org/verify?hash=8a97b9be..."
        '400':
          description: Ungültige Anfrage
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                no_file:
                  summary: Keine Datei
                  value:
                    error: "NO_FILE"
                    message: "Keine Datei oder URL angegeben"
                author_required:
                  summary: Autor fehlt
                  value:
                    error: "AUTHOR_REQUIRED"
                    message: "Datei muss einen gültigen Autor haben."
                    hint: "Füge YAML Frontmatter mit author: hinzu."
                invalid_format:
                  summary: Format nicht unterstützt
                  value:
                    error: "INVALID_FORMAT"
                    message: "Format nicht unterstützt: application/zip"
                    supported: ["image/webp", "image/png", "image/jpeg", "image/gif", "application/pdf", "text/markdown", "text/plain"]
        '409':
          description: Datei bereits signiert
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "ALREADY_SIGNED"
                  message:
                    type: string
                    example: "Diese Datei wurde bereits signiert."
                  existing_event:
                    type: object

  /verify:
    get:
      operationId: verifySignature
      summary: Signatur verifizieren
      description: Prüft ob eine Datei auf Nostr signiert wurde.
      tags:
        - Verification
      parameters:
        - name: hash
          in: query
          description: SHA-256 Hash der Datei
          schema:
            type: string
        - name: url
          in: query
          description: Datei-URL (Hash wird berechnet)
          schema:
            type: string
            format: uri
      responses:
        '200':
          description: Verifizierungsergebnis
          content:
            application/json:
              schema:
                type: object
                properties:
                  verified:
                    type: boolean
                  hash:
                    type: string
                  event:
                    type: object
                  metadata:
                    type: object
                  relays_found:
                    type: array
                    items:
                      type: string

  /badge:
    get:
      operationId: getBadge
      summary: Verifizierungs-Badge
      description: Generiert ein SVG-Badge für verifizierte Dateien.
      tags:
        - Badge
      parameters:
        - name: hash
          in: query
          schema:
            type: string
        - name: event
          in: query
          schema:
            type: string
        - name: url
          in: query
          schema:
            type: string
      responses:
        '200':
          description: SVG Badge
          content:
            image/svg+xml:
              schema:
                type: string

components:
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          enum:
            - NO_FILE
            - AUTHOR_REQUIRED
            - FILE_TOO_LARGE
            - INVALID_FORMAT
            - ALREADY_SIGNED
            - FILE_FETCH_FAILED
        message:
          type: string
        hint:
          type: string
        supported:
          type: array
          items:
            type: string
          description: Liste unterstützter MIME-Types (bei INVALID_FORMAT)
